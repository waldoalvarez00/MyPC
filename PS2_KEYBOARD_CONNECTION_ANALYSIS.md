# PS/2 Keyboard Connection Analysis - MiSTer Integration

## Executive Summary

**Status**: ⚠️ **PARTIALLY CONNECTED** - Keyboard input works (USB→FPGA), but keyboard output is disconnected (FPGA→HPS)

**Impact**:
- ✅ Keyboard input **WORKS** - User can type and send commands
- ⚠️ Keyboard output **BROKEN** - LED status updates and keyboard reset commands cannot be sent

**Root Cause**: Connection wires exist but are **hardcoded to idle** instead of being properly connected to HPS_IO module

## Architecture Overview

### MiSTer PS/2 Framework

The MiSTer FPGA platform does **NOT** use physical PS/2 ports. Instead, it uses:

```
USB Keyboard (Physical)
        ↓
   ARM HPS Processor
        ↓
   HPS_BUS Interface (49-bit bus)
        ↓
   hps_io Module (PS/2 Emulation)
        ↓
   PS/2 Protocol Signals (emulated)
        ↓
   FPGA Core (80186 PC emulation)
```

### Signal Flow

**Direction: USB Keyboard → FPGA (Working ✅)**
```
USB Device → ARM HPS → HPS_BUS → hps_io module →
  ps2_kbd_clk_out (wps2_kbd_clk_2) → KFPS2KB receiver →
  keycode → CPU
```

**Direction: FPGA → USB Keyboard (Broken ⚠️)**
```
CPU → KFPS2KB_Send_Data →
  ps2_kbd_clk_1 (wps2_kbd_clk_1) ✗ DISCONNECTED → hps_io
  ps2_kbd_data_1 (wps2_kbd_data_1) ✗ DISCONNECTED → hps_io
```

## Detailed Connection Analysis

### File: `/home/user/MyPC/Quartus/mycore.sv`

#### 1. Signal Declarations (Lines 311-314)

```systemverilog
wire wps2_kbd_clk_2;    // FROM hps_io (HPS → FPGA clock)
wire wps2_kbd_data_1;   // TO hps_io (FPGA → HPS data) - GENERATED BUT NOT CONNECTED!
wire wps2_kbd_clk_1;    // TO hps_io (FPGA → HPS clock) - GENERATED BUT NOT CONNECTED!
wire wps2_kbd_data_2;   // FROM hps_io (HPS → FPGA data)
```

#### 2. HPS_IO Module Instantiation (Lines 364-397)

**Configuration:**
```systemverilog
hps_io #(.CONF_STR(CONF_STR), .PS2DIV(10), .PS2WE(1), .WIDE(1)) hps_io
```
- `PS2DIV=10` - Enables PS/2 emulation with ~10 kHz clock
- `PS2WE=1` - **Enables bidirectional PS/2 support**

**Connections:**
```systemverilog
// HPS → FPGA (Working)
.ps2_kbd_clk_out(wps2_kbd_clk_2),    // ✅ Connected
.ps2_kbd_data_out(wps2_kbd_data_2),  // ✅ Connected

// FPGA → HPS (BROKEN!)
.ps2_kbd_clk_in(/*wps2_kbd_clk_1*/ 1'b1),   // ❌ HARDCODED TO 1!
.ps2_kbd_data_in(/*wps2_kbd_data_1*/ 1'b1), // ❌ HARDCODED TO 1!
```

**Comment on Line 2122**: `// Still needs proper connection` - **Developer knew this was incomplete!**

#### 3. KFPS2KB Receiver Module (Lines 2083-2103)

```systemverilog
KFPS2KB u_KFPS2KB
(
    .clock(sys_clk),
    .reset(post_sdram_reset),

    // PS/2 Inputs (FROM HPS)
    .device_clock(wps2_kbd_clk_2),  // ✅ Receives from HPS
    .device_data(wps2_kbd_data_2),   // ✅ Receives from HPS

    // Outputs to CPU
    .irq(ps2_kbd_intr),              // ✅ Generates interrupts
    .keycode(keycode_buf),           // ✅ Provides scancodes

    // Special functions
    .swap_video(swap_video),         // ✅ Working
    ...
);
```
**Status**: ✅ **Fully functional** - Receives keyboard data from USB keyboard via HPS

#### 4. KFPS2KB_Send_Data Module (Lines 2123-2139)

```systemverilog
KFPS2KB_Send_Data u_KFPS2KB_Send_Data
(
    .clock(sys_clk),
    .reset(post_sdram_reset),

    // PS/2 Bidirectional Interface
    .device_clock(wps2_kbd_clk_2),      // ✅ Input: Clock from HPS
    .device_clock_out(wps2_kbd_clk_1),  // ❌ Output: Generated but NOT connected to HPS!
    .device_data_out(wps2_kbd_data_1),  // ❌ Output: Generated but NOT connected to HPS!

    .sending_data_flag(lock_recv_clock),

    // Command interface
    .send_request(~prev_ps2_reset_n & ps2_reset_n),  // Triggered on keyboard reset
    .send_data(8'hFF)                                 // Reset command (0xFF)
);
```
**Status**: ⚠️ **Module works but outputs are disconnected** - Cannot send to HPS

### File: `/home/user/MyPC/Quartus/sys/hps_io.sv`

#### PS/2 Interface Definition (Lines 82-85, 581-582)

```systemverilog
// Module ports
output ps2_kbd_clk_out,   // HPS → FPGA
output ps2_kbd_data_out,  // HPS → FPGA
input  ps2_kbd_clk_in,    // FPGA → HPS
input  ps2_kbd_data_in,   // FPGA → HPS

// Internal PS/2 transceiver instantiation
ps2_device keyboard
(
    ...
    .ps2_clk_out(ps2_kbd_clk_out),
    .ps2_dat_out(ps2_kbd_data_out),

    // These inputs are OR'd with !PS2WE
    .ps2_clk_in(ps2_kbd_clk_in  || !PS2WE),   // With PS2WE=1, uses actual input
    .ps2_dat_in(ps2_kbd_data_in || !PS2WE),   // With PS2WE=1, uses actual input
    ...
);
```

When `PS2WE=1` (as configured in mycore.sv):
- `ps2_kbd_clk_in` should receive clock from FPGA
- `ps2_kbd_data_in` should receive data from FPGA

**But mycore.sv provides `1'b1` (idle) instead of actual signals!**

## Problem Summary

### The Disconnect

| Signal | Generated By | Should Connect To | Actually Connected To | Status |
|--------|--------------|-------------------|----------------------|--------|
| `wps2_kbd_clk_1` | KFPS2KB_Send_Data | hps_io.ps2_kbd_clk_in | **1'b1 (hardcoded)** | ❌ BROKEN |
| `wps2_kbd_data_1` | KFPS2KB_Send_Data | hps_io.ps2_kbd_data_in | **1'b1 (hardcoded)** | ❌ BROKEN |
| `wps2_kbd_clk_2` | hps_io.ps2_kbd_clk_out | KFPS2KB.device_clock | wps2_kbd_clk_2 | ✅ WORKING |
| `wps2_kbd_data_2` | hps_io.ps2_kbd_data_out | KFPS2KB.device_data | wps2_kbd_data_2 | ✅ WORKING |

### Impact on Functionality

**What Works:**
1. ✅ **Keyboard Input** - User can type on USB keyboard
2. ✅ **Scancode Generation** - Proper PC/XT scancodes generated
3. ✅ **Interrupt Generation** - IRQ1 triggers on keypress
4. ✅ **Special Keys** - Ctrl+F11/F12 for video swapping
5. ✅ **Keyboard Reset Request** - CPU can request keyboard reset

**What Doesn't Work:**
1. ❌ **Keyboard LED Updates** - Caps Lock, Num Lock, Scroll Lock LEDs cannot be controlled
2. ❌ **Keyboard Reset Confirmation** - Reset command (0xFF) sent but not transmitted to keyboard
3. ❌ **Keyboard Acknowledgments** - ACK/NAK responses cannot reach the keyboard
4. ❌ **Typematic Rate Settings** - Cannot configure repeat rate/delay

### Why It Mostly Works Anyway

Most PC software doesn't require bidirectional PS/2 communication:
- **DOS Applications**: Rarely update keyboard LEDs
- **BIOS**: Usually doesn't configure keyboard
- **Games**: Don't use keyboard LEDs

However, some software **will have issues**:
- Windows 3.x/95/98 (LED status updates)
- Linux/Unix (Num Lock/Caps Lock indicators)
- Keyboard diagnostic utilities

## Fix Required

### Code Change in `mycore.sv` (Lines 386-387)

**Current (Broken):**
```systemverilog
.ps2_kbd_clk_in(/*wps2_kbd_clk_1*/ 1'b1),
.ps2_kbd_data_in(/*wps2_kbd_data_1*/ 1'b1),
```

**Fixed:**
```systemverilog
.ps2_kbd_clk_in(wps2_kbd_clk_1),
.ps2_kbd_data_in(wps2_kbd_data_1),
```

### Verification Steps

After applying fix:

1. **Compile and Test**:
   ```bash
   cd /home/user/MyPC/Quartus
   quartus_sh --flow compile mycore
   ```

2. **Test Keyboard LEDs**:
   - Boot DOS or Windows
   - Press Num Lock, Caps Lock, Scroll Lock
   - Verify USB keyboard LEDs update

3. **Test Keyboard Reset**:
   - Monitor keyboard reset sequence
   - Verify 0xAA (self-test passed) response

4. **Check Timing**:
   - Verify no timing violations introduced
   - Check 50 MHz timing closure still met

## Additional Notes

### Why This Wasn't Noticed

1. **Functional for Basic Use** - Keyboard input works perfectly
2. **LED Control Rare** - Most retro software doesn't use LEDs
3. **USB Keyboard Abstraction** - MiSTer's ARM processor might handle some LED updates directly
4. **Testing Gap** - Testbenches focus on CPU interface, not HPS interface

### Related Modules

The following modules are correctly implemented and tested:
- ✅ `PS2KeyboardController.sv` - CPU interface (18/18 tests passing)
- ✅ `KFPS2KB.sv` - PS/2 receiver (functional)
- ✅ `KFPS2KB_Send_Data.sv` - PS/2 transmitter (functional, just disconnected)
- ✅ `hps_io.sv` - MiSTer framework (supports bidirectional PS/2)

### Mouse Status

The PS/2 **mouse** appears to be properly connected:
```systemverilog
.ps2_mouse_clk_out(wps2_mouse_clk_in),    // ✅ Connected
.ps2_mouse_data_out(wps2_mouse_data_in),  // ✅ Connected
.ps2_mouse_clk_in(wps2_mouse_clk_out),    // ✅ Connected
.ps2_mouse_data_in(wps2_mouse_data_out),  // ✅ Connected
```

The mouse bidirectional communication **is** properly wired, which confirms the keyboard disconnect is an oversight, not a design decision.

## Conclusion

The PS/2 keyboard **is connected** to the MiSTer via USB keyboard emulation through the HPS_BUS interface. The keyboard **receives input correctly**, but **cannot send output back** due to hardcoded signal values.

**This is a simple fix** - just uncomment and connect two signal wires. The infrastructure is completely in place; the signals are generated but not connected to their destination.

**Recommendation**: Apply the fix and rebuild the FPGA image to enable full bidirectional PS/2 keyboard support.

---

**Analysis Date**: 2025-11-15
**Analyzed By**: Claude (Anthropic)
**Files Examined**:
- `/home/user/MyPC/Quartus/mycore.sv` (2234 lines)
- `/home/user/MyPC/Quartus/sys/hps_io.sv` (26615 bytes)
- `/home/user/MyPC/Quartus/rtl/common/Top.sv`
- `/home/user/MyPC/Quartus/rtl/ps2/PS2KeyboardController.sv`
