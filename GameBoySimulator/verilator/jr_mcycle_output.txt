=== JR Instruction MCycle Analysis ===

This test tracks machine cycle (MCycle) and T-state progression
to identify where JR instruction execution fails.

Uploading boot ROM...
Simulating cart download...
Ready

Running simulation...

Boot completed at cycle 39824

=== JP Instruction at $0150 (opcode=0xC3) ===
Cycle   PC     IR    MCycle TState MCycles_total  cpu_clken ce_cpu
-----   ----   ----  ------ ------ -------------  --------- ------
40366  $0150   $C3   M1     T2        3          0         0
40370  $0150   $C3   M1     T2        3          0         0
40374  $0150   $C3   M1     T2        3          0         0
40378  $0150   $C3   M1     T2        3          0         0
40382  $0150   $C3   M1     T3        3          0         0
40386  $0150   $C3   M1     T3        3          0         0
40390  $0150   $C3   M1     T3        3          0         0
40394  $0150   $C3   M1     T3        3          0         0
40398  $0150   $C3   M1     T3        3          0         0
40402  $0150   $C3   M1     T3        3          0         0
40406  $0150   $C3   M1     T3        3          0         0
40410  $0150   $C3   M1     T3        3          0         0
40414  $0150   $C3   M1     T3        3          0         0
40418  $0150   $C3   M1     T3        3          0         0
40422  $0150   $C3   M1     T3        3          0         0
40426  $0150   $C3   M1     T3        3          0         0
40430  $0150   $C3   M1     T3        3          0         0
40434  $0150   $C3   M1     T3        3          0         0
40438  $0150   $C3   M1     T3        3          0         0
40442  $0150   $C3   M1     T3        3          0         0
40446  $0150   $C3   M1     T4        3          0         0
40450  $0150   $C3   M1     T4        3          0         0
40454  $0150   $C3   M1     T4        3          0         0
40458  $0150   $C3   M1     T4        3          0         0
40462  $0150   $C3   M1     T4        3          0         0
40466  $0150   $C3   M1     T4        3          0         0
40470  $0150   $C3   M1     T4        3          0         0
40474  $0150   $C3   M1     T4        3          0         0
40478  $0150   $C3   M1     T4        3          0         0
40482  $0150   $C3   M1     T4        3          0         0
40486  $0150   $C3   M1     T4        3          0         0
40490  $0150   $C3   M1     T4        3          0         0
40494  $0150   $C3   M1     T4        3          0         0
40498  $0150   $C3   M1     T4        3          0         0
40502  $0150   $C3   M1     T4        3          0         0
40506  $0150   $C3   M1     T4        3          0         0
40510  $0150   $C3   M1     T5        3          0         0
40514  $0150   $C3   M1     T5        3          0         0
40518  $0150   $C3   M1     T5        3          0         0
40522  $0150   $C3   M1     T5        3          0         0
40526  $0151   $C3   M2     T2        3          0         0
40530  $0151   $C3   M2     T2        3          0         0
40534  $0151   $C3   M2     T2        3          0         0
40538  $0151   $C3   M2     T2        3          0         0
40542  $0151   $C3   M2     T3        3          0         0
40546  $0151   $C3   M2     T3        3          0         0
40550  $0151   $C3   M2     T3        3          0         0
40554  $0151   $C3   M2     T3        3          0         0
40558  $0151   $C3   M2     T3        3          0         0
40562  $0151   $C3   M2     T3        3          0         0
40566  $0151   $C3   M2     T3        3          0         0
40570  $0151   $C3   M2     T3        3          0         0
40574  $0151   $C3   M2     T3        3          0         0
40578  $0151   $C3   M2     T3        3          0         0
40582  $0151   $C3   M2     T3        3          0         0
40586  $0151   $C3   M2     T3        3          0         0
40590  $0151   $C3   M2     T3        3          0         0
40594  $0151   $C3   M2     T3        3          0         0
40598  $0151   $C3   M2     T3        3          0         0
40602  $0151   $C3   M2     T3        3          0         0
40606  $0151   $C3   M2     T4        3          0         0
40610  $0151   $C3   M2     T4        3          0         0
40614  $0151   $C3   M2     T4        3          0         0
40618  $0151   $C3   M2     T4        3          0         0
40622  $0151   $C3   M2     T4        3          0         0
40626  $0151   $C3   M2     T4        3          0         0
40630  $0151   $C3   M2     T4        3          0         0
40634  $0151   $C3   M2     T4        3          0         0
40638  $0151   $C3   M2     T4        3          0         0
40642  $0151   $C3   M2     T4        3          0         0
40646  $0151   $C3   M2     T4        3          0         0
40650  $0151   $C3   M2     T4        3          0         0
40654  $0151   $C3   M2     T4        3          0         0
40658  $0151   $C3   M2     T4        3          0         0
40662  $0151   $C3   M2     T4        3          0         0
40666  $0151   $C3   M2     T4        3          0         0
40670  $0151   $C3   M2     T5        3          0         0
40674  $0151   $C3   M2     T5        3          0         0
40678  $0151   $C3   M2     T5        3          0         0
40682  $0151   $C3   M2     T5        3          0         0
40686  $0152   $C3   M3     T2        3          0         0
40690  $0152   $C3   M3     T2        3          0         0
40694  $0152   $C3   M3     T2        3          0         0
40698  $0152   $C3   M3     T2        3          0         0
40702  $0152   $C3   M3     T3        3          0         0
40706  $0152   $C3   M3     T3        3          0         0
40710  $0152   $C3   M3     T3        3          0         0
40714  $0152   $C3   M3     T3        3          0         0
40718  $0152   $C3   M3     T3        3          0         0
40722  $0152   $C3   M3     T3        3          0         0
40726  $0152   $C3   M3     T3        3          0         0
40730  $0152   $C3   M3     T3        3          0         0
40734  $0152   $C3   M3     T3        3          0         0
40738  $0152   $C3   M3     T3        3          0         0
40742  $0152   $C3   M3     T3        3          0         0
40746  $0152   $C3   M3     T3        3          0         0
40750  $0152   $C3   M3     T3        3          0         0
40754  $0152   $C3   M3     T3        3          0         0
40758  $0152   $C3   M3     T3        3          0         0
40762  $0152   $C3   M3     T3        3          0         0

(JP trace stopped after 400 cycles)

=== JR Instruction at $0160 (opcode=0x18) ===
Cycle   PC     IR    MCycle TState MCycles_total  cpu_clken ce_cpu
-----   ----   ----  ------ ------ -------------  --------- ------
40846  $0160   $C3   M1     T2        3          0         0
40850  $0160   $C3   M1     T2        3          0         0
40854  $0160   $C3   M1     T2        3          0         0
40858  $0160   $C3   M1     T2        3          0         0
40862  $0160   $C3   M1     T3        3          0         0
40866  $0160   $C3   M1     T3        3          0         0
40870  $0160   $C3   M1     T3        3          0         0
40874  $0160   $C3   M1     T3        3          0         0
40878  $0160   $C3   M1     T3        3          0         0
40882  $0160   $C3   M1     T3        3          0         0
40886  $0160   $C3   M1     T3        3          0         0
40890  $0160   $C3   M1     T3        3          0         0
40894  $0160   $C3   M1     T3        3          0         0
40898  $0160   $C3   M1     T3        3          0         0
40902  $0160   $C3   M1     T3        3          0         0
40906  $0160   $C3   M1     T3        3          0         0
40910  $0160   $C3   M1     T3        3          0         0
40914  $0160   $C3   M1     T3        3          0         0
40918  $0160   $C3   M1     T3        3          0         0
40922  $0160   $C3   M1     T3        3          0         0
40926  $0160   $18   M1     T4        3          0         0
40930  $0160   $18   M1     T4        3          0         0
40934  $0160   $18   M1     T4        3          0         0
40938  $0160   $18   M1     T4        3          0         0
40942  $0160   $18   M1     T4        3          0         0
40946  $0160   $18   M1     T4        3          0         0
40950  $0160   $18   M1     T4        3          0         0
40954  $0160   $18   M1     T4        3          0         0
40958  $0160   $18   M1     T4        3          0         0
40962  $0160   $18   M1     T4        3          0         0
40966  $0160   $18   M1     T4        3          0         0
40970  $0160   $18   M1     T4        3          0         0
40974  $0160   $18   M1     T4        3          0         0
40978  $0160   $18   M1     T4        3          0         0
40982  $0160   $18   M1     T4        3          0         0
40986  $0160   $18   M1     T4        3          0         0
40990  $0160   $18   M1     T5        3          0         0
40994  $0160   $18   M1     T5        3          0         0
40998  $0160   $18   M1     T5        3          0         0
41002  $0160   $18   M1     T5        3          0         0
41006  $0161   $18   M2     T2        3          0         0
41010  $0161   $18   M2     T2        3          0         0
41014  $0161   $18   M2     T2        3          0         0
41018  $0161   $18   M2     T2        3          0         0
41022  $0161   $18   M2     T3        3          0         0
41026  $0161   $18   M2     T3        3          0         0
41030  $0161   $18   M2     T3        3          0         0
41034  $0161   $18   M2     T3        3          0         0
41038  $0161   $18   M2     T3        3          0         0
41042  $0161   $18   M2     T3        3          0         0
41046  $0161   $18   M2     T3        3          0         0
41050  $0161   $18   M2     T3        3          0         0
41054  $0161   $18   M2     T3        3          0         0
41058  $0161   $18   M2     T3        3          0         0
41062  $0161   $18   M2     T3        3          0         0
41066  $0161   $18   M2     T3        3          0         0
41070  $0161   $18   M2     T3        3          0         0
41074  $0161   $18   M2     T3        3          0         0
41078  $0161   $18   M2     T3        3          0         0
41082  $0161   $18   M2     T3        3          0         0
41086  $0161   $18   M2     T4        3          0         0
41090  $0161   $18   M2     T4        3          0         0
41094  $0161   $18   M2     T4        3          0         0
41098  $0161   $18   M2     T4        3          0         0
41102  $0161   $18   M2     T4        3          0         0
41106  $0161   $18   M2     T4        3          0         0
41110  $0161   $18   M2     T4        3          0         0
41114  $0161   $18   M2     T4        3          0         0
41118  $0161   $18   M2     T4        3          0         0
41122  $0161   $18   M2     T4        3          0         0
41126  $0161   $18   M2     T4        3          0         0
41130  $0161   $18   M2     T4        3          0         0
41134  $0161   $18   M2     T4        3          0         0
41138  $0161   $18   M2     T4        3          0         0
41142  $0161   $18   M2     T4        3          0         0
41146  $0161   $18   M2     T4        3          0         0
41150  $0161   $18   M2     T5        3          0         0
41154  $0161   $18   M2     T5        3          0         0
41158  $0161   $18   M2     T5        3          0         0
41162  $0161   $18   M2     T5        3          0         0
41166  $0162   $18   M3     T2        3          0         0

>>> JR FAILED: PC at $0162 (HALT) instead of $0163 (target) ❌
    Expected: $0160 → $0163 (relative jump)
    Actual:   $0160 → $0161 → $0162 (byte-by-byte)


=== Analysis ===

Expected JR execution:
  MCycle[0] (M1): Fetch opcode 0x18 from $0160
  MCycle[1] (M2): Fetch offset byte from $0161, Inc_PC asserted
  MCycle[2] (M3): JumpE asserted, PC = PC + sign_extended_offset
                  PC should become $0163 (0x0161 + 2)

If JR failed:
  - Check if MCycle reached M3 (MCycle[2])
  - Check if MCycles_total was set to 3
  - Look for premature instruction completion

Next steps:
  1. Compare JP vs JR MCycle progression
  2. Verify MCycles_total is 3 for JR (should match microcode)
  3. Check if M3 cycle executes for JR

